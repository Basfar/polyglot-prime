<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InteractionsFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TechBD Hub (Prime)</a> &gt; <a href="index.source.html" class="el_package">org.techbd.service.http</a> &gt; <span class="el_source">InteractionsFilter.java</span></div><h1>InteractionsFilter.java</h1><pre class="source lang-java linenums">package org.techbd.service.http;

import java.io.IOException;
import java.util.Optional;
import java.util.concurrent.atomic.AtomicInteger;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.ApplicationContext;
import org.springframework.core.annotation.Order;
import org.springframework.lang.NonNull;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;
import org.springframework.web.util.ContentCachingRequestWrapper;
import org.springframework.web.util.ContentCachingResponseWrapper;
import org.techbd.service.http.Interactions.RequestResponseEncountered;
import org.techbd.sql.ArtifactsDataSource;
import org.techbd.udi.UdiPrimeJpaConfig;
import org.techbd.util.ArtifactStore;
import org.techbd.util.ArtifactStore.Artifact;
import org.techbd.util.ArtifactStore.JdbcPersistence;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebFilter;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

@Component
@WebFilter(urlPatterns = &quot;/*&quot;)
@Order(-999)
<span class="nc" id="L33">public class InteractionsFilter extends OncePerRequestFilter {</span>
    @Value(&quot;${org.techbd.service.http.interactions.default-persist-strategy:#{null}}&quot;)
    private String defaultPersistStrategy;

    @Autowired
    private JavaMailSender mailSender;

    @Autowired
    private UdiPrimeJpaConfig udiPrimeJpaConfig;

    @Autowired
    private ApplicationContext appContext;

<span class="nc" id="L46">    public static final Interactions interactions = new Interactions();</span>

    protected static final void setActiveRequestTenant(final @NonNull HttpServletRequest request,
            final @NonNull Interactions.Tenant tenant) {
<span class="nc" id="L50">        request.setAttribute(&quot;activeHttpRequestTenant&quot;, tenant);</span>
<span class="nc" id="L51">    }</span>

    public static final Interactions.Tenant getActiveRequestTenant(final @NonNull HttpServletRequest request) {
<span class="nc" id="L54">        return (Interactions.Tenant) request.getAttribute(&quot;activeHttpRequestTenant&quot;);</span>
    }

    protected static final void setActiveRequestEnc(final @NonNull HttpServletRequest request,
            final @NonNull Interactions.RequestEncountered re) {
<span class="nc" id="L59">        request.setAttribute(&quot;activeHttpRequestEncountered&quot;, re);</span>
<span class="nc" id="L60">        setActiveRequestTenant(request, re.tenant());</span>
<span class="nc" id="L61">    }</span>

    public static final Interactions.RequestEncountered getActiveRequestEnc(final @NonNull HttpServletRequest request) {
<span class="nc" id="L64">        return (Interactions.RequestEncountered) request.getAttribute(&quot;activeHttpRequestEncountered&quot;);</span>
    }

    protected static final void setActiveInteraction(final @NonNull HttpServletRequest request,
            final @NonNull Interactions.RequestResponseEncountered rre) {
<span class="nc" id="L69">        request.setAttribute(&quot;activeHttpInteraction&quot;, rre);</span>
<span class="nc" id="L70">    }</span>

    public static final Interactions.RequestResponseEncountered getActiveInteraction(
            final @NonNull HttpServletRequest request) {
<span class="nc" id="L74">        return (Interactions.RequestResponseEncountered) request.getAttribute(&quot;activeHttpInteraction&quot;);</span>
    }

    @Override
    protected void doFilterInternal(final @NonNull HttpServletRequest origRequest,
            @NonNull final HttpServletResponse origResponse, @NonNull final FilterChain chain)
            throws IOException, ServletException {
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (isAsyncDispatch(origRequest)) {</span>
<span class="nc" id="L82">            chain.doFilter(origRequest, origResponse);</span>
<span class="nc" id="L83">            return;</span>
        }

        // for the /Bundle/$validate (at least, and maybe even /Bundle) we want
        // to store the entire request/response cycle including the response payload;
        // for everything else we only want to keep the request and response without
        // payloads
<span class="nc" id="L90">        final var requestURI = origRequest.getRequestURI();</span>
<span class="nc" id="L91">        final var persistPayloads = requestURI.contains(&quot;/Bundle/$validate&quot;);</span>

<span class="nc" id="L93">        final var mutatableReq = new ContentCachingRequestWrapper(origRequest);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        final var requestBody = persistPayloads ? mutatableReq.getContentAsByteArray()</span>
<span class="nc" id="L95">                : &quot;persistPayloads = false&quot;.getBytes();</span>

        // Prepare a serializable RequestEncountered as early as possible in
        // request cycle and store it as an attribute so that other filters
        // and controllers can use the common &quot;active request&quot; instance.
<span class="nc" id="L100">        final var requestEncountered = new Interactions.RequestEncountered(mutatableReq, requestBody);</span>
<span class="nc" id="L101">        setActiveRequestEnc(origRequest, requestEncountered);</span>

<span class="nc" id="L103">        final var mutatableResp = new ContentCachingResponseWrapper(origResponse);</span>

<span class="nc" id="L105">        chain.doFilter(mutatableReq, mutatableResp);</span>

        // for the /Bundle/$validate (at least, and maybe even /Bundle) we want
        // to store the entire request/response cycle including the response payload;
        // for everything else we only want to keep the request and response without
        // payloads
<span class="nc" id="L111">        RequestResponseEncountered rre = null;</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (!persistPayloads) {</span>
<span class="nc" id="L113">            rre = new Interactions.RequestResponseEncountered(requestEncountered,</span>
                    new Interactions.ResponseEncountered(mutatableResp, requestEncountered,
<span class="nc" id="L115">                            &quot;persistPayloads = false&quot;.getBytes()));</span>
        } else {
<span class="nc" id="L117">            rre = new Interactions.RequestResponseEncountered(requestEncountered,</span>
                    new Interactions.ResponseEncountered(mutatableResp, requestEncountered,
<span class="nc" id="L119">                            mutatableResp.getContentAsByteArray()));</span>
        }

<span class="nc" id="L122">        interactions.addHistory(rre);</span>
<span class="nc" id="L123">        setActiveInteraction(mutatableReq, rre);</span>

        // TODO: cache this in the constructor
<span class="nc" id="L126">        final var udiPrimePersistStrategy = new JdbcPersistence(</span>
<span class="nc" id="L127">                new ArtifactsDataSource.PostgreSqlBuilder().dataSource(udiPrimeJpaConfig.udiPrimaryDataSource())</span>
<span class="nc" id="L128">                        .build());</span>

        // we want to find our persistence strategy in either properties or in header;
        // because X-TechBD-Interaction-Persistence-Strategy is global, document it in
        // SwaggerConfig.customGlobalHeaders
<span class="nc" id="L133">        final var strategyJson = Optional</span>
<span class="nc" id="L134">                .ofNullable(mutatableReq.getHeader(Interactions.Servlet.HeaderName.Request.PERSISTENCE_STRATEGY))</span>
<span class="nc" id="L135">                .orElse(defaultPersistStrategy);</span>
<span class="nc" id="L136">        final var asb = new ArtifactStore.Builder()</span>
<span class="nc" id="L137">                .strategyJson(strategyJson)</span>
<span class="nc" id="L138">                .provenanceJson(mutatableReq.getHeader(Interactions.Servlet.HeaderName.Request.PROVENANCE))</span>
<span class="nc" id="L139">                .mailSender(mailSender)</span>
<span class="nc" id="L140">                .always(udiPrimePersistStrategy)</span>
<span class="nc" id="L141">                .appContext(appContext);</span>
<span class="nc" id="L142">        final var ps = asb.build();</span>
<span class="nc" id="L143">        mutatableResp.setHeader(Interactions.Servlet.HeaderName.Response.PERSISTENCE_STRATEGY_ARGS, strategyJson);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (ps != null) {</span>
<span class="nc" id="L145">            final AtomicInteger info = new AtomicInteger(0);</span>
<span class="nc" id="L146">            final AtomicInteger issue = new AtomicInteger(0);</span>
<span class="nc" id="L147">            mutatableResp.setHeader(Interactions.Servlet.HeaderName.Response.PERSISTENCE_STRATEGY_FACTORY,</span>
<span class="nc" id="L148">                    ps.getClass().getName());</span>
<span class="nc" id="L149">            ps.persist(</span>
<span class="nc" id="L150">                    ArtifactStore.jsonArtifact(rre, rre.interactionId().toString(),</span>
<span class="nc" id="L151">                            InteractionsFilter.class.getName() + &quot;.interaction&quot;, asb.getProvenance()),</span>
<span class="nc" id="L152">                    Optional.of(new ArtifactStore.PersistenceReporter() {</span>
                        @Override
                        public void info(String message) {
<span class="nc" id="L155">                            mutatableResp</span>
<span class="nc" id="L156">                                    .setHeader(Interactions.Servlet.HeaderName.Response.PERSISTENCE_STRATEGY_INSTANCE</span>
<span class="nc" id="L157">                                            + &quot;-Info-&quot; + info.getAndIncrement(), message);</span>
<span class="nc" id="L158">                        }</span>

                        @Override
                        public void issue(String message) {
<span class="nc" id="L162">                            mutatableResp</span>
<span class="nc" id="L163">                                    .setHeader(Interactions.Servlet.HeaderName.Response.PERSISTENCE_STRATEGY_INSTANCE</span>
<span class="nc" id="L164">                                            + &quot;-Issue-&quot; + issue.getAndIncrement(), message);</span>
<span class="nc" id="L165">                        }</span>

                        @Override
                        public void persisted(Artifact artifact, String... location) {
                            // not doing anything with this yet
<span class="nc" id="L170">                        }</span>
                    }));

        }

<span class="nc" id="L175">        mutatableResp.copyBodyToResponse();</span>
<span class="nc" id="L176">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>