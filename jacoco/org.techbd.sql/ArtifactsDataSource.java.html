<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArtifactsDataSource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TechBD Hub (Prime)</a> &gt; <a href="index.source.html" class="el_package">org.techbd.sql</a> &gt; <span class="el_source">ArtifactsDataSource.java</span></div><h1>ArtifactsDataSource.java</h1><pre class="source lang-java linenums">package org.techbd.sql;

import java.io.IOException;
import java.io.Reader;
import java.io.StringWriter;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.SQLException;
import java.sql.Types;
import java.util.Comparator;
import java.util.Map;
import java.util.Optional;
import java.util.Properties;
import java.util.function.BiFunction;
import java.util.function.Predicate;
import java.util.regex.Pattern;
import java.util.stream.Stream;

import javax.sql.DataSource;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.core.io.ClassPathResource;
import org.springframework.jdbc.datasource.init.ResourceDatabasePopulator;
import org.springframework.jdbc.datasource.init.ScriptException;
import org.techbd.util.ArtifactStore;
import org.techbd.util.ArtifactStore.Artifact;
import org.techbd.util.InterpolateEngine;

public class ArtifactsDataSource {
<span class="nc" id="L34">    private static final Logger LOG = LoggerFactory.getLogger(ArtifactsDataSource.class);</span>
    private final DataSource dataSource;
    private final Optional&lt;Exception&gt; dsException;
    private final BiFunction&lt;Connection, ArtifactRecord, Optional&lt;Exception&gt;&gt; persistDelegate;

    public ArtifactsDataSource(final DataSource dataSource, final Optional&lt;Exception&gt; dsException,
<span class="nc" id="L40">            BiFunction&lt;Connection, ArtifactRecord, Optional&lt;Exception&gt;&gt; persistDelegate) {</span>
<span class="nc" id="L41">        this.dataSource = dataSource;</span>
<span class="nc" id="L42">        this.dsException = dsException;</span>
<span class="nc" id="L43">        this.persistDelegate = persistDelegate;</span>
<span class="nc" id="L44">    }</span>

    public Optional&lt;Exception&gt; dsException() {
<span class="nc" id="L47">        return dsException;</span>
    }

    public boolean isValid() {
<span class="nc" id="L51">        return dsException.isEmpty();</span>
    }

    public DataSource dataSource() {
<span class="nc" id="L55">        return dataSource;</span>
    }

    public Optional&lt;Exception&gt; persistArtifact(Artifact artifact) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (!isValid()) {</span>
<span class="nc" id="L60">            return dsException;</span>
        }

<span class="nc" id="L63">        try (var conn = dataSource.getConnection()) {</span>
<span class="nc" id="L64">            conn.setAutoCommit(true);</span>
<span class="nc" id="L65">            final var content = new StringWriter();</span>
<span class="nc" id="L66">            try (Reader reader = artifact.getReader()) {</span>
<span class="nc" id="L67">                reader.transferTo(content);</span>
<span class="nc" id="L68">            } catch (IOException e) {</span>
<span class="nc" id="L69">                return Optional.of(e);</span>
<span class="nc" id="L70">            }</span>

<span class="nc" id="L72">            return persistDelegate.apply(conn, new ArtifactRecord(</span>
<span class="nc" id="L73">                    artifact.getArtifactId(),</span>
<span class="nc" id="L74">                    artifact.getNamespace(),</span>
<span class="nc" id="L75">                    content.toString(),</span>
                    &quot;application/json&quot;,
<span class="nc" id="L77">                    ArtifactStore.toJsonText(artifact.getProvenance())));</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L79">            return Optional.of(e);</span>
        }
    }

<span class="nc" id="L83">    public record ArtifactRecord(String artifactId, String namespace, String content, String contentType,</span>
            String provenance) {
    }

<span class="nc" id="L87">    public static class PostgreSqlBuilder {</span>
<span class="nc" id="L88">        private static final Pattern MIGRATABLE_SCRIPT_PATTERN = Pattern.compile(&quot;^\\d+.*\\.pg\\.sql$&quot;);</span>
        private DataSource dataSource;
<span class="nc" id="L90">        private String url = &quot;jdbc:postgresql://hostname/database-name?user=*****&amp;password=*****&amp;sslmode=require&quot;;</span>
<span class="nc" id="L91">        private String scriptsPath = &quot;sql/artifact&quot;;</span>
<span class="nc" id="L92">        private BiFunction&lt;Connection, ArtifactRecord, Optional&lt;Exception&gt;&gt; persistFn = PostgreSqlBuilder::callStoredProcPersist;</span>

        public PostgreSqlBuilder url(final String url) {
<span class="nc" id="L95">            this.url = url;</span>
<span class="nc" id="L96">            return this;</span>
        }

        public PostgreSqlBuilder scriptsPath(final String scriptPath) {
<span class="nc" id="L100">            this.scriptsPath = scriptPath;</span>
<span class="nc" id="L101">            return this;</span>
        }

        public PostgreSqlBuilder dataSource(final DataSource dataSource) {
<span class="nc" id="L105">            this.dataSource = dataSource;</span>
<span class="nc" id="L106">            return this;</span>
        }

        public PostgreSqlBuilder userAgentArgs(final Map&lt;String, Object&gt; args) {
<span class="nc" id="L110">            final var ie = new InterpolateEngine(args);</span>

<span class="nc" id="L112">            Optional.ofNullable(args.get(&quot;url&quot;))</span>
<span class="nc" id="L113">                    .ifPresent(url -&gt; url(ie.interpolate(url.toString())));</span>

<span class="nc" id="L115">            Optional.ofNullable(args.get(&quot;persistFn&quot;))</span>
<span class="nc" id="L116">                    .ifPresent(persistFnValue -&gt; {</span>
<span class="nc bnc" id="L117" title="All 3 branches missed.">                        switch (persistFnValue.toString()) {</span>
<span class="nc" id="L118">                            case &quot;insertDML&quot; -&gt; persistFn(PostgreSqlBuilder::insertPersist);</span>
<span class="nc" id="L119">                            case &quot;callStoredProc&quot; -&gt; persistFn(PostgreSqlBuilder::callStoredProcPersist);</span>
                            default -&gt;
<span class="nc" id="L121">                                throw new IllegalArgumentException(&quot;Unknown persist function: &quot; + persistFnValue);</span>
                        }
<span class="nc" id="L123">                    });</span>
<span class="nc" id="L124">            return this;</span>
        }

        public PostgreSqlBuilder persistFn(
                BiFunction&lt;Connection, ArtifactRecord, Optional&lt;Exception&gt;&gt; persistFunction) {
<span class="nc" id="L129">            this.persistFn = persistFunction;</span>
<span class="nc" id="L130">            return this;</span>
        }

        public ArtifactsDataSource build() {
            // if the data source is supplied use it, otherwise try to get it dynamically
<span class="nc" id="L135">            final var dataSource = Optional.ofNullable(this.dataSource).orElseGet(() -&gt; {</span>
<span class="nc" id="L136">                final var dmds = new org.springframework.jdbc.datasource.DriverManagerDataSource();</span>
<span class="nc" id="L137">                dmds.setDriverClassName(&quot;org.postgresql.Driver&quot;);</span>
<span class="nc" id="L138">                dmds.setUrl(url);</span>
<span class="nc" id="L139">                return dmds;</span>
            });
<span class="nc" id="L141">            try (var connection = dataSource.getConnection()) {</span>
<span class="nc" id="L142">                Optional&lt;Exception&gt; esException = Optional.empty();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                if (scriptsPath != null) {</span>
<span class="nc" id="L144">                    esException = executeResourceScripts(connection, scriptsPath,</span>
                            path -&gt; {
<span class="nc" id="L146">                                final var matches = MIGRATABLE_SCRIPT_PATTERN.matcher(path.getFileName().toString())</span>
<span class="nc" id="L147">                                        .matches();</span>
<span class="nc" id="L148">                                LOG.info(String.format(&quot;PostgreSQL test match: %s (%s)&quot;,</span>
<span class="nc" id="L149">                                        path.getFileName().toString(), matches));</span>
<span class="nc" id="L150">                                return matches;</span>
                            });
                }
<span class="nc" id="L153">                return new ArtifactsDataSource(dataSource, esException, persistFn);</span>
<span class="nc" id="L154">            } catch (final SQLException e) {</span>
<span class="nc" id="L155">                return new ArtifactsDataSource(dataSource, Optional.of(e), persistFn);</span>
            }
        }

        public static Optional&lt;Exception&gt; insertPersist(final Connection connection, final ArtifactRecord record) {
<span class="nc" id="L160">            final var sql = &quot;&quot;&quot;</span>
                        INSERT INTO &quot;artifact&quot; (&quot;artifact_id&quot;, &quot;namespace&quot;, &quot;content_type&quot;, &quot;content&quot;, &quot;provenance&quot;)
                        VALUES (?, ?, ?, ?, ?)
                    &quot;&quot;&quot;;
<span class="nc" id="L164">            try (var stmt = connection.prepareStatement(sql)) {</span>
<span class="nc" id="L165">                stmt.setString(1, record.artifactId());</span>
<span class="nc" id="L166">                stmt.setString(2, record.namespace());</span>
<span class="nc" id="L167">                stmt.setString(3, record.contentType());</span>
<span class="nc" id="L168">                stmt.setString(4, record.content());</span>

<span class="nc" id="L170">                final var provenance = record.provenance();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                if (provenance != null) {</span>
<span class="nc" id="L172">                    stmt.setObject(5, provenance, java.sql.Types.OTHER);</span>
                } else {
<span class="nc" id="L174">                    stmt.setNull(5, java.sql.Types.OTHER);</span>
                }

<span class="nc" id="L177">                final var result = stmt.executeUpdate();</span>
<span class="nc" id="L178">                LOG.info(String.format(&quot;PostgreSqlBuilder::insertPersist %s execute result %d&quot;, record.artifactId(),</span>
<span class="nc" id="L179">                        result));</span>
<span class="nc" id="L180">                return Optional.empty();</span>
<span class="nc" id="L181">            } catch (SQLException e) {</span>
<span class="nc" id="L182">                return Optional.of(e);</span>
            }
        }

        public static Optional&lt;Exception&gt; callStoredProcPersist(final Connection connection,
                final ArtifactRecord record) {
<span class="nc" id="L188">            final var sql = &quot;&quot;&quot;</span>
                    {? = call public.fn_insert_artifact(?, ?, ?, cast(? as jsonb), cast(? as jsonb), cast(? as jsonb))}
                    &quot;&quot;&quot;;
<span class="nc" id="L191">            try (CallableStatement stmt = connection.prepareCall(sql)) {</span>
<span class="nc" id="L192">                stmt.registerOutParameter(1, Types.VARCHAR);</span>
<span class="nc" id="L193">                stmt.setString(2, record.namespace);</span>
<span class="nc" id="L194">                stmt.setString(3, record.content);</span>
<span class="nc" id="L195">                stmt.setString(4, record.contentType);</span>
<span class="nc" id="L196">                final var provenance = record.provenance();</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                if (provenance != null) {</span>
<span class="nc" id="L198">                    stmt.setObject(5, provenance, java.sql.Types.OTHER);</span>
                } else {
<span class="nc" id="L200">                    stmt.setNull(5, java.sql.Types.OTHER);</span>
                }
<span class="nc" id="L202">                stmt.setNull(6, java.sql.Types.VARCHAR);</span>
<span class="nc" id="L203">                stmt.setNull(7, java.sql.Types.VARCHAR);</span>
<span class="nc" id="L204">                stmt.execute();</span>
<span class="nc" id="L205">                final String newId = stmt.getString(1);</span>
<span class="nc" id="L206">                LOG.info(String.format(&quot;PostgreSqlBuilder::callStoredProcPersist new Artifact Id: %s&quot;, newId));</span>
<span class="nc" id="L207">                return Optional.empty();</span>
<span class="nc" id="L208">            } catch (SQLException e) {</span>
<span class="nc" id="L209">                return Optional.of(e);</span>
            }
        }
    }

<span class="nc" id="L214">    public static class DuckDbBuilder {</span>
<span class="nc" id="L215">        private static final Pattern MIGRATABLE_SCRIPT_PATTERN = Pattern.compile(&quot;^\\d+.*\\.duckdb\\.sql$&quot;);</span>
<span class="nc" id="L216">        private String url = &quot;jdbc:duckdb:&quot; + System.getProperty(&quot;user.dir&quot;) + &quot;/artifacts.duckdb&quot;;</span>
        private String motherDuckToken;
<span class="nc" id="L218">        private String scriptsPath = &quot;sql/artifact&quot;;</span>
<span class="nc" id="L219">        private BiFunction&lt;Connection, ArtifactRecord, Optional&lt;Exception&gt;&gt; persistFn = DuckDbBuilder::defaultPersist;</span>

        public DuckDbBuilder userAgentArgs(final Map&lt;String, Object&gt; args) {
<span class="nc" id="L222">            final var ie = new InterpolateEngine(args);</span>

<span class="nc" id="L224">            Optional.ofNullable(args.get(&quot;url&quot;))</span>
<span class="nc" id="L225">                    .ifPresent(url -&gt; url(ie.interpolate(url.toString())));</span>

<span class="nc" id="L227">            Optional.ofNullable(args.get(&quot;motherDuck&quot;))</span>
<span class="nc" id="L228">                    .filter(Map.class::isInstance)</span>
<span class="nc" id="L229">                    .map(Map.class::cast)</span>
<span class="nc" id="L230">                    .ifPresent(mdArgs -&gt; Optional.ofNullable(mdArgs.get(&quot;token&quot;))</span>
<span class="nc" id="L231">                            .filter(String.class::isInstance)</span>
<span class="nc" id="L232">                            .map(String.class::cast)</span>
<span class="nc" id="L233">                            .ifPresent(token -&gt; Optional.ofNullable(mdArgs.get(&quot;db&quot;))</span>
<span class="nc" id="L234">                                    .filter(String.class::isInstance)</span>
<span class="nc" id="L235">                                    .map(String.class::cast)</span>
<span class="nc" id="L236">                                    .ifPresent(db -&gt; motherDuckDatabase(ie.interpolate(token), ie.interpolate(db)))));</span>

<span class="nc" id="L238">            return this;</span>
        }

        public DuckDbBuilder url(final String url) {
<span class="nc" id="L242">            this.url = url;</span>
<span class="nc" id="L243">            return this;</span>
        }

        public DuckDbBuilder scriptsPath(final String scriptPath) {
<span class="nc" id="L247">            this.scriptsPath = scriptPath;</span>
<span class="nc" id="L248">            return this;</span>
        }

        public DuckDbBuilder localFsPath(final String localFsPath) {
<span class="nc" id="L252">            return this.url(&quot;jdbc:duckdb:&quot; + localFsPath);</span>
        }

        public DuckDbBuilder userDirFsPath(final String localFsPath) {
<span class="nc bnc" id="L256" title="All 2 branches missed.">            return this.url(&quot;jdbc:duckdb:&quot; + System.getProperty(&quot;user.dir&quot;) + (localFsPath.startsWith(&quot;/&quot;) ? &quot;&quot; : &quot;/&quot;)</span>
                    + localFsPath);
        }

        public DuckDbBuilder motherDuckDatabase(final String token, final String mdbName) {
<span class="nc" id="L261">            this.motherDuckToken = token;</span>
<span class="nc" id="L262">            return this.url(&quot;jdbc:duckdb:md:&quot; + mdbName);</span>
        }

        public DuckDbBuilder persistFunction(
                BiFunction&lt;Connection, ArtifactRecord, Optional&lt;Exception&gt;&gt; persistFunction) {
<span class="nc" id="L267">            this.persistFn = persistFunction;</span>
<span class="nc" id="L268">            return this;</span>
        }

        public ArtifactsDataSource build() {
<span class="nc" id="L272">            final var dataSource = new org.springframework.jdbc.datasource.DriverManagerDataSource();</span>
<span class="nc" id="L273">            dataSource.setDriverClassName(&quot;org.duckdb.DuckDBDriver&quot;);</span>
<span class="nc" id="L274">            dataSource.setUrl(url);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">            if (motherDuckToken != null) {</span>
<span class="nc" id="L276">                final var config = new Properties();</span>
<span class="nc" id="L277">                config.setProperty(&quot;motherduck_token&quot;, motherDuckToken);</span>
<span class="nc" id="L278">                config.setProperty(&quot;custom_user_agent&quot;, ArtifactsDataSource.DuckDbBuilder.class.getName());</span>
<span class="nc" id="L279">                dataSource.setConnectionProperties(config);</span>
            }
<span class="nc" id="L281">            try (var connection = dataSource.getConnection()) {</span>
<span class="nc" id="L282">                Optional&lt;Exception&gt; esException = Optional.empty();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                if (scriptsPath != null) {</span>
<span class="nc" id="L284">                    esException = executeResourceScripts(connection, scriptsPath,</span>
                            path -&gt; {
<span class="nc" id="L286">                                final var matches = MIGRATABLE_SCRIPT_PATTERN.matcher(path.getFileName().toString())</span>
<span class="nc" id="L287">                                        .matches();</span>
<span class="nc" id="L288">                                LOG.info(String.format(&quot;DuckDbBuilder test match: %s (%s)&quot;,</span>
<span class="nc" id="L289">                                        path.getFileName().toString(), matches));</span>
<span class="nc" id="L290">                                return matches;</span>
                            });
                }
<span class="nc" id="L293">                return new ArtifactsDataSource(dataSource, esException, persistFn);</span>
<span class="nc" id="L294">            } catch (final SQLException e) {</span>
<span class="nc" id="L295">                return new ArtifactsDataSource(dataSource, Optional.of(e), persistFn);</span>
            }
        }

        public static Optional&lt;Exception&gt; defaultPersist(final Connection connection, final ArtifactRecord record) {
<span class="nc" id="L300">            final var sql = &quot;&quot;&quot;</span>
                        INSERT INTO &quot;artifact&quot; (&quot;artifact_id&quot;, &quot;namespace&quot;, &quot;content_type&quot;, &quot;content&quot;, &quot;provenance&quot;)
                        VALUES (?, ?, ?, ?, ?)
                    &quot;&quot;&quot;;
<span class="nc" id="L304">            try (var stmt = connection.prepareStatement(sql)) {</span>
<span class="nc" id="L305">                stmt.setString(1, record.artifactId());</span>
<span class="nc" id="L306">                stmt.setString(2, record.namespace());</span>
<span class="nc" id="L307">                stmt.setString(3, record.contentType());</span>
<span class="nc" id="L308">                stmt.setString(4, record.content());</span>

<span class="nc" id="L310">                final var provenance = record.provenance();</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                if (provenance != null) {</span>
<span class="nc" id="L312">                    stmt.setString(5, provenance);</span>
                } else {
<span class="nc" id="L314">                    stmt.setNull(5, java.sql.Types.VARCHAR);</span>
                }

<span class="nc" id="L317">                final var result = stmt.executeUpdate();</span>
<span class="nc" id="L318">                LOG.info(String.format(&quot;DuckDbBuilder::defaultPersist %s execute result %d&quot;, record.artifactId(),</span>
<span class="nc" id="L319">                        result));</span>
<span class="nc" id="L320">                return Optional.empty();</span>
<span class="nc" id="L321">            } catch (SQLException e) {</span>
<span class="nc" id="L322">                return Optional.of(e);</span>
            }
        }
    }

    @SafeVarargs
    public static Optional&lt;Exception&gt; executeResourceScripts(final Connection connection, final String scriptsPath,
            Predicate&lt;Path&gt;... predicates) {
<span class="nc" id="L330">        LOG.info(&quot;preparing executeResourceScripts&quot;);</span>
<span class="nc" id="L331">        final var populator = new ResourceDatabasePopulator();</span>
<span class="nc" id="L332">        try (Stream&lt;Path&gt; paths = Files.walk(Paths.get(new ClassPathResource(scriptsPath).getURI()))) {</span>
<span class="nc" id="L333">            var filteredPaths = paths.filter(Files::isRegularFile);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            for (Predicate&lt;Path&gt; predicate : predicates) {</span>
<span class="nc" id="L335">                filteredPaths = filteredPaths.filter(predicate);</span>
            }

<span class="nc" id="L338">            filteredPaths.sorted(Comparator.comparing(Path::getFileName))</span>
<span class="nc" id="L339">                    .forEach(path -&gt; {</span>
<span class="nc" id="L340">                        final var relativePath = scriptsPath + &quot;/&quot; + path.getFileName().toString();</span>
<span class="nc" id="L341">                        final var cpr = new ClassPathResource(relativePath);</span>
<span class="nc" id="L342">                        LOG.info(String.format(&quot;%s discovered in %s (executeScripts)&quot;, cpr.toString(), scriptsPath));</span>
<span class="nc" id="L343">                        populator.addScript(cpr);</span>
<span class="nc" id="L344">                    });</span>

<span class="nc" id="L346">            populator.populate(connection);</span>
<span class="nc" id="L347">            LOG.info(String.format(&quot;%s populated in connection&quot;, populator.toString()));</span>
<span class="nc" id="L348">            return Optional.empty();</span>
<span class="nc" id="L349">        } catch (IOException | ScriptException e) {</span>
<span class="nc" id="L350">            LOG.error(String.format(&quot;%s exception in executeScripts&quot;, e), e);</span>
<span class="nc" id="L351">            return Optional.of(e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>